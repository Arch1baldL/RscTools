## RscTools — Copilot Instructions

Purpose: Help AI agents work productively in this small R package for single-cell RNA-seq workflows built around Seurat.

### Repo Overview
- Package: RscTools (MIT). See [DESCRIPTION](DESCRIPTION) and [NAMESPACE](NAMESPACE).
- Code lives in [R/](R). Exported functions (via roxygen2):
  - `run_qc()` — batch QC and preprocessing
  - `run_cc_regression()` — cell-cycle scoring and SCT regression
  - `plot_pca_variance()` — cumulative PCA variance plot
  - `plot_umap_border()` — UMAP scatter with density borders
- Man pages in [man/](man) are generated by roxygen2.

### Module Structure
- `run_*` (workflow helpers): Accept a Seurat object (or a named list) and run standard analysis steps; keep side effects minimal (set/restore assay when needed; clean up temporary metadata); report progress via `message()/warning()/stop()`; return a Seurat object or a same-named list.
- `plot_*` (plot polish): Read-only on `obj`; control appearance via column names/numeric args; extract coordinates/metadata with `Seurat::FetchData()`; consistently use `rlang::.data` to avoid NSE notes; prefer `theme_void()/coord_fixed()` for layout consistency.

### Development Workflow
- Docs/NAMESPACE are roxygen2-driven (see `Roxygen` fields in [DESCRIPTION](DESCRIPTION)). After changing roxygen comments in [R/*.R](R):
  - Generate docs: in R, run `roxygen2::roxygenise()` or `devtools::document()`.
  - Iteration: use `devtools::load_all()` to test changes without full install.
- Package check (optional): `devtools::check()`.

### Language Conventions
- Roxygen docs and user-facing documentation (README, man pages, vignettes): English.
- User-facing messages and errors: English.
- Warning prefix style: start all warnings with "⚠️ [function_name]" (UTF-8). Keep the rest of the message concise and actionable.
 - Emoji prefixes for consistency (UTF-8):
   - Running: "▶️ [function_name]"
   - Completed: "✅ [function_name]"
   - Warning: "⚠️ [function_name]"
   - Error: "❌ [function_name]"
- Inline code comments for developers: Chinese, concise and practical.
- Keep function/argument names and public APIs in English.

### Key Patterns and Assumptions
- Seurat integration:
  - `run_qc()` expects typical RNA-seq features (`nFeature_RNA`, `nCount_RNA`) and computes `percent.mt` via a species-specific pattern.
  - `run_cc_regression()` uses `Seurat::cc.genes.updated.2019` and sets `DefaultAssay(obj) <- "RNA"` before scoring/regression; returns an object with an `SCT` assay.
  - `plot_umap_border()` assumes `UMAP_1`, `UMAP_2` and given metadata columns exist in `FetchData()`; draws contours at `ndensity=0.2` and uses “ghost points” to avoid clipping.
  - `plot_pca_variance()` reads `obj@reductions[[reduction]]@stdev` to build cumulative variance and marks 90%/95% thresholds when available.
- Tidyverse style: pipes and scoped imports; use `rlang::.data` in aesthetics/mapping to avoid NSE notes.

### Function Notes (what to pass, what you get)
- `run_qc(object_list, species = "mouse", max_nFeature_RNA = 5000, max_percent_mt = 3, scale_all_genes = TRUE, plot_qc = TRUE)`
  - Accepts a single Seurat or a named list. Returns the processed Seurat or a named list (samples with failed `percent.mt` are skipped with a warning).
  - Species controls mitochondrial gene regex: `^mt-` (mouse) vs `^MT-` (human).
  - Plots pre/post QC violin plots using patchwork when `plot_qc=TRUE`.
  - Implementation: [R/run_qc.R](R/run_qc.R).
- `run_cc_regression(obj, species = "mouse")`
  - Valid species: `mouse`, `human` (mouse uses Title Case genes). Stops if no CC genes overlap `rownames(obj)`.
  - Returns Seurat with SCT assay after regressing `S.Score` and `G2M.Score` (vst.flavor="v2").
  - Implementation: [R/run_cc_regression.R](R/run_cc_regression.R).
- `plot_pca_variance(obj, reduction = "pca", max_pcs = 50)`
  - Requires PCA reduction present (`obj@reductions[[reduction]]@stdev`). Stops if <2 PCs.
  - Annotates first PCs reaching 90%/95% cumulative variance when achievable.
  - Implementation: [R/plot_pca_variance.R](R/plot_pca_variance.R).
- `plot_umap_border(obj, group_points, group_borders, min_cells = 10, expand_ratio = 0.3, pt_size = 0.5, line_width = 1.2, label_size = 5)`
  - Uses `Seurat::FetchData()` to get `UMAP_1`, `UMAP_2`, and the two grouping columns; stops if all groups are smaller than `min_cells`.
  - Draws polygon borders with `stat_density_2d(..., contour_var = "ndensity", breaks = 0.2)` and labeled UMAP axes via `annotate()` with open arrows.
  - Implementation: [R/plot_umap_border.R](R/plot_umap_border.R).

### Common Gotchas
- Missing reductions/coords or wrong metadata key → Seurat `FetchData()`/slot access errors. Ensure required columns exist before plotting.
- `run_qc()` may drop samples if `percent.mt` cannot be computed (e.g., wrong species or gene symbols). It injects a temporary `all` group for plotting and removes it afterward.
- `run_cc_regression()` halts if none of the CC genes are present in `rownames(obj)`; make sure gene symbols match species/case.

### Minimal Usage Examples
```r
# Load development version locally
devtools::load_all()

# QC (single object)
obj_qc <- run_qc(seurat_obj, species = "mouse", max_percent_mt = 5)

# Cell cycle regression
obj_sct <- run_cc_regression(obj_qc, species = "mouse")

# PCA variance plot (after RunPCA)
p_var <- plot_pca_variance(obj_sct, reduction = "pca", max_pcs = 40)
print(p_var)

# UMAP borders (ensure UMAP and metadata columns exist)
p_umap <- plot_umap_border(obj_sct, group_points = "seurat_clusters", group_borders = "cell_type")
print(p_umap)
```

### Adding New Functions
- Place code in [R/](R) with roxygen2 comments and `@export`.
- Declare imports via `@import`/`@importFrom` (match existing style), then run `devtools::document()` to update [NAMESPACE](NAMESPACE) and [man/](man).

If anything here feels off or incomplete (e.g., additional internal workflows, devtools shortcuts you use), tell me what to adjust and I’ll update this guide.
